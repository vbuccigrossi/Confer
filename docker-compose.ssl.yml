version: "3.9"

services:
  app:
    build:
      context: ./docker/php
    container_name: latch-app
    restart: unless-stopped
    working_dir: /var/www/html
    volumes:
      - ./app:/var/www/html
    environment:
      PHP_OPCACHE_VALIDATE_TIMESTAMPS: "1"
    depends_on:
      - postgres
      - redis

  queue:
    build:
      context: ./docker/php
    container_name: latch-queue
    restart: unless-stopped
    working_dir: /var/www/html
    volumes:
      - ./app:/var/www/html
    depends_on:
      - app
      - redis
    command: sh -lc "php artisan queue:work --sleep=1 --tries=3 --backoff=3"

  scheduler:
    build:
      context: ./docker/php
    container_name: latch-scheduler
    restart: unless-stopped
    working_dir: /var/www/html
    volumes:
      - ./app:/var/www/html
    depends_on:
      - app
    command: sh -lc "php artisan schedule:work"

  websockets:
    build:
      context: ./docker/php
    container_name: latch-websockets
    restart: unless-stopped
    working_dir: /var/www/html
    volumes:
      - ./app:/var/www/html
    depends_on:
      - app
      - redis
    ports:
      - "8081:8081"
    command: sh -lc "php artisan reverb:start --host=0.0.0.0 --port=8081"

  node:
    image: node:lts-alpine
    container_name: latch-node
    working_dir: /var/www/html
    volumes:
      - ./app:/var/www/html
    ports:
      - "5173:5173"
    command: sh -lc "if [ -f package.json ]; then npm install --legacy-peer-deps && npm run dev; else echo 'No package.json yet (run make bootstrap)'; tail -f /dev/null; fi"
    environment:
      - VITE_DEV_SERVER_HOST=0.0.0.0
      - CHOKIDAR_USEPOLLING=true

  nginx:
    image: nginx:alpine
    container_name: latch-nginx
    restart: unless-stopped
    volumes:
      - ./app:/var/www/html
      - ./docker/nginx/nginx-ssl.conf:/etc/nginx/conf.d/default.conf:ro
      - certbot-etc:/etc/letsencrypt
      - certbot-var:/var/lib/letsencrypt
      - certbot-www:/var/www/certbot
    ports:
      - "8080:80"
      - "443:443"
    depends_on:
      - app

  certbot:
    image: certbot/certbot:latest
    container_name: latch-certbot
    volumes:
      - certbot-etc:/etc/letsencrypt
      - certbot-var:/var/lib/letsencrypt
      - certbot-www:/var/www/certbot
    entrypoint: /bin/sh -c "trap exit TERM; while :; do certbot renew --webroot -w /var/www/certbot --quiet; sleep 12h & wait $${!}; done"

  postgres:
    image: postgres:16-alpine
    container_name: latch-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: app
      POSTGRES_USER: app
      POSTGRES_PASSWORD: app
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - "54320:5432"

  redis:
    image: redis:7-alpine
    container_name: latch-redis
    restart: unless-stopped
    ports:
      - "6379:6379"

  mailhog:
    image: mailhog/mailhog:latest
    container_name: latch-mailhog
    restart: unless-stopped
    ports:
      - "8025:8025"

volumes:
  pgdata:
  certbot-etc:
  certbot-var:
  certbot-www:
